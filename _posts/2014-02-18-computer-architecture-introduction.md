---
layout: post
title: "计算机体系结构概述"
description: ""
category: 
tags: [CS]
---
计算机体系结构的本质是对这个世界的抽象，来源于人们如何看待这个世界。最基本的莫过于"输入->计算->输出"。
通俗来讲，通过鼠标，键盘和网络输入数据，CPU完成计算，并最终完成输出终端显示计算结果。

有些细节，比如各种语言的语法，api，你看过的开源代码，如果你不经常用的话，那么很容易忘记。所以，本文忽略了一些即使看了，当时也理解了；但是由于工作关系，你不用还是会忘记的细节。

在计算机系统演化过程中，存在两个基本原理：

* 性价比原理：速度越块，价格越高，容量就越小。寄存器，CPU缓存，内存，磁盘完美地体现了这种关系。
![]({{ BASE_PATH }}/images/csapp1/memory-hierarchy-cn.png )
* 局部性原理：该原理分成两部分：时间局部性和空间局部性。在具备良好时间局部性的程序中，被引用一次的存储器位置很可能在不远的将来会被再次引用。在具备良好空间局部性的程序中，被引用一次的存储器位置的附近位置很可能在不远的将来会被再次引用。大部分编写良好的程序都能复合这个原理。这个原理告诉我们，把一个程序经常需要的数据放到高速缓存里面，即使这个缓存很小，能够极大提高性能。
 
## CPU

程序是由一系列指令组成的。当执行一个程序时，需要把磁盘的指令读入到内存中。然后再把内存中的数据读入到寄存器中，这样CPU就能够执行该程序了。之所以需要经过磁盘，内存和寄存器这些IO操作，是因为上文说的“性价比原理”。大量程序无法全部存放在小容量的存储器里面，但是为了充分利用CPU的性能，不让CPU发生太大延迟，才会把数据放到存取数据速度最快的里面。 当然，另外还有一点，就是磁盘相对来说是非易失存储器。


![]({{ BASE_PATH }}/images/cs/latency.jpeg )


### 流水线执行
通常，处理一个指令内部包含如下几个操作，分别是：

* 取指：从存储器读取指令字节
* 译码：从寄存器文件读入操作数
* 计算：算术/逻辑单元执行指令代表的操作。  
* 访存：写入或读取存储器数据  
* 写回：把结果写入到寄存器文件  
* 更新pc ：将PC设置成下一个指令的地址


所谓流水线执行，就是把这6个操作放在流水线上执行。那么所谓流水线，可以看看这篇[经典的5级流水线](http://blog.csdn.net/muxiqingyang/article/details/6661417)介绍

### 分支预测
处理器会使用精密的分支预测逻辑，来试图猜测每条跳转指令如何执行。如果预测成功，那么指令流水线就会充满着指令；否则如果预测失败，则要求处理器丢掉它为该跳转指令后所有指令所做的工作，然后再开始从正确位置处起始的指令开始执行。

在stackoverflow有个经典的问题：[Why is processing a sorted array faster than an unsorted array?](http://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-an-unsorted-array)，就说明这种情况。

### 乱序执行 
 
当CPU在执行指令时，如果发现所需要的数据不在Cache时，则需要从外部存储器中取，而这个过程通常需要几十，甚至几百个Cycle。如果CPU是顺序执行这些指令时，则后面的指令需要等待。所以如果CPU支持乱序执行的话，那么就可以先执行后面不依赖该数据的指令，进而提升CPU计算性能。
 
## 存储器结构
背景知识 http://my.oschina.net/geecoodeer/blog/191767
overhead 
顺序存储： 
随机存储：

旋转磁盘和固态硬盘

磁盘 ：512字节 300扇区 20000磁道  2盘面 5盘片 

寻道时间 旋转时间 传送时间 前2者耗时较大，访问第一个自己耗费很长时间，后面几乎不耗费时间。所以操作系统会预读。。

逻辑磁盘块：现代磁盘构造复杂，为了对os隐藏这些复杂性，现代磁盘提供了一个简单的视图，称为逻辑块。磁盘控制器维护着逻辑块和实际物理的磁盘扇区之间的映射关系。os执行i/o操作时，通过制定逻辑块号，磁盘控制器的固件执行一个快速查找，将逻辑号翻译成（盘面，磁道，删除）的3元组，这个3元组唯一标识了对应的物理扇区。控制器的硬件解释这个3元组，将读、写头移动到适当的柱面，等待扇区移动到读写头下，将读写头感知的位放到控制器里面的一个小缓冲区内，然后复制到内存中。

cpu --存储控制器  -- 内存 -- 先将行数据复制到内存的内部缓冲区内，然后再根据列去取数据

地址，数据 内存 

存储器映射I/O: cpu使用这种技术来想i/o设备发送命令。首先在地址空间中。有一块地址是为与I/O设备通信保留的。每个这样的地址称为一个I/O port。当一个I/O设备连接到总线时，它与一个或多个端口相关联。

cpu可能通过执行3个对 I/O port （比如为0Xa0）的存储指令。当磁盘控制器收到cpu读命令后，它将逻辑块翻译成扇区地址 ，然后将内容直接传送到主存，不需要cpu的干涉。这种过程称为DMA。

TLB MMU

## 虚拟内存
多个进程共享内存

虚拟内存原理 ：更多进程需要更多内存，高效管理内存。 
 方便管理内存，避免重复IO 虚拟内存 支持
	 内存容量不够 swap机制

direct mapped cache  将内存地址分为3部分  标记位  组索引 和 偏移量，偏移量表示从什么地方开始取数据。

内存分页 和 cache 分页相对应。

虚拟存储器是一个数组，一个存放在磁盘上的N个连续的字节大小的单元组成的数组。
分为 未分配 ，未缓存，已缓存，
   未分配  不占用内存和磁盘空间
   未缓存  不占用内存，占用磁盘
   已缓存  占用内存和磁盘
虚拟存储器分为多个页面，每个页面称为虚拟页，是一个大小固定的块。

页表（在内存中） 数据结构，存放了虚拟页到物理页的映射关系（读写目标）
操作系统 负责维护页表的内容，以及在磁盘和内存中传送页。（写）
MMU（硬件），地址翻译硬件，负责在将虚拟内存转换成物理内存时读取页表。（读）    
     高速缓存、内存
发生缺页中断后，会把被牺牲的脏页写回以及交换页面。

TLB是MMU硬件内部的一个小缓存，用来加速翻译。

## 网络交互
I/O多路复用（I/O multiplexing）首先构造一张有关描述符的列表，然后调用一个函数，直到这些描述符中的一个已经准备I/O时，该函数才返回。在返回时，它告诉进程哪些描述符已经准备好可以进行I/O

poll、pselect和select这3个函数使我们能够执行I/O多路复用。

p581 

电话类比网络连接关系原来在UP中已经阐述。

TIME_WAIT 允许最大跳数内的并且小于2MSL的数据包重传

P36 3次握手状态

P78

p85  baklog 图

listen 指定 backlog。内核维护两个队列 未完成连接队列（处于SYN_RCVD状态），已完成连接队列
syn flood 攻击  忽略了大量关于c语言之间的描述

accept 监听套接字 和  已连接套接字  前者一直存在  后者用完则关闭

p92

p122 必读 nio

select 的最大描述符设置需要重新编译或者使用新版本的的参数设置；线性搜索，扩展能力差。
选择 epoll

select 可读，可写，异常
无限等待，等待某段时间，不等待

p361 解释了 为什么需要finishConnect

## 线程并发 
参考我的多线程的并发知识 背景
原子操作锁定内存地址，其他程序等待。 线程和进程    
锁的本质内部实现？总线锁定？行锁
 hedengc 多线程简单过下
 乘法指令和加法指令是可以并行执行的。

## POSIX
内核 vs 库函数   sbrk vs malloc
creat 是 open 的简便函数，封装了open
lseek 没有发生实际的io操作
进程终止时，内核会自动释放句柄
read ahead 、write behind  P71
sync 加入写队列缓存就返回，fsync 写入到磁盘后才返回
为了打开文件，需要具有文件所在目录的执行权限
void *
僵尸进程，处理signal 。sigal handler

## 编写高性能代码
CPU优化章节 
  
扫一扫+工具检测 
降低循环内的低效计算(比如重复的方法调用)
数组和链表的区别 数组适合随机读取，便于使用2分法。 
并发锁的粒度和策略
 ### 信息编码
补码是非对称编码
补码计算 

P43 介绍 反码和原码

根据http://www.hardtoc.com/archives/119 引用的标准， -2147483648 是一个常量表达式，首先是获取2147483648 ，然后计算-这个符号。但是在获取时2147483648，已经发生溢出。会变成一个 unsigned long int 或者long long int. 
 cache miss （矩阵计算，二维数组本质上是一维数组，双重循环），false sharing

## 汇编
r大blog 2指令汇编，3指令汇编。 如果把mov r1,r2 等类似的指令放到一个类里面，mov就相当于方法，r1,r2就是方法参数了。 这些方法都
对汇编指令的学习，属于生态系统和职责分工。 编译原理，cpu，操作系统， 但是由于遗忘特性

## 参考

CSAPP
UP
AUPE
《大话处理器》
http://www.cnblogs.com/baiweiguo/archive/2013/01/15/2861286.html
http://blog.sweelia.com/articles/2013/01/05/1357370792163.html
[SMP，NUMA 和 MPP 三种系统架构](http://www.chenjunlu.com/2012/08/parallel-computer-memory-architectures/)
 

{% include JB/setup %}
