---
layout: post
title: "大型互联网架构和分布式系统原理概述"
description: ""
category: 分布式系统
tags: [分布式系统]
---
 
本文旨在简单介绍大型互联网的架构和核心组件实现原理。 理论上讲，从安装配置，最佳实践以及源码来剖析各个组件，这个自然是极好的。由于笔者时间以及知识有限，有很多知识没有在工作中亲自实践的机会。所以有些地方语焉不详，还请大家多多指教。

## 大型互联网架构

解决问题的通用思路是将分而治之（divide-and-conquer），将大问题分为若干个小问题，各个击破。在大型互联网的架构实践中，无一不体现这种思想。

### 架构目标
商业利益，注意性价比
 
系统的吞吐能力，指系统在某一时间可以处理的数据总量，通常可以用系统每秒处理的总的数据量来衡量；系统的响应延迟，指系统完成某一功能需要使用的时间；系统的并发能力，指系统可以同时完成某一功能的能力，通常也用 QPS(query per second)来衡量
 
马车，八匹马   集群，分布式
功能需求
LL 低延迟 见下图的描述，
HA 高可用 ，主要手段是冗余 
系统的可用性(availability)指系统在面对各种异常时可以正确提供服务的能力。系统的可用性可
以用系统停服务的时间与正常服务的时间的比例来衡量，也可以用某功能的失败次数与成功次数的
比例来衡量。可用性是分布式的重要指标，衡量了系统的鲁棒性，是系统容错能力的体现。 
一致性
分布式系统为了提高可用性，总是不可避免的使用副本的机制，从而引发副本一致性的问题。
根据具体的业务需求的不同，分布式系统总是提供某种一致性模型，并基于此模型提供具体的服务。
正如 1.2.2  提到的，越是强的一致的性模型，对于用户使用来说使用起来越简单。例如通常我们总
是希望某次更新后可以立刻读到最新的修改，如果成功更新后的数据依旧有可能不一致读到旧数据，
那么用户就需要在写入数据时加入序列号等信息，并在读取数据时首先自行实现过滤去重后再使用
数据。 

低成本  ACID的C不同于CAP中的C
http://zh.wikipedia.org/wiki/ACID

原子性，保证操作的逻辑，要么最终全部成功，要么最终全部失败。一致性约束可见性，要么看到的是事务处理前的状态，要么是处理完的状态，处理中的状态不可见。持久性就是事务结束后看到的状态，不可退回事务前的状态。 隔离性，与性能有关，影响到一致性保证的级别。 隔离性的概念一知半解，呵呵

原子性：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。
一致性：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的默认规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。
隔离性：当两个或者多个事务并发访问（此处访问指查询和修改的操作）数据库的同一数据时所表现出的相互关系。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。
持久性：在事务完成以后，该事务对数据库所作的更改便持久地保存在数据库之中，并且是完全的。


base cap 
HR 高可靠

HL 大流量
伸缩性 ：注重线性扩展，是否可以容易通过加入机器来处理不断上升的用户访问压力。
系统的伸缩性(scalability)指分布式系统通过扩展集群机器规模提高系统性能（吞吐、延迟、
并发）、存储容量、计算能力的特性。可扩展性是分布式系统的特有性质。分布式系统的设计初衷就
是利用集群多机的能力处理单机无法解决的问题。然而，完成某一具体任务的所需要的机器数目即
集群规模取决于系统的性能和任务的要求。当任务的需求随着具体业务不断提高时，除了升级系统
的性能，另一个做法就是通过增加机器的方式扩展系统的规模。好的分布式系统总在追求“线性扩
展性”，也就是使得系统的某一指标可以随着集群中的机器数量线性增长。 
扩展性 ：主要解决功能扩展
### 计算机体系结构
NUMA SMP
 
overhead 
顺序存储： 
随机存储：

### 典型实现
下面典型的一次web交互请求示意图。
![]({{ BASE_PATH }}/images/distributed-system/http request via big internet site.png )

浏览器访问DNS解析，本地如果存在缓存，host主机映射 

区分重复计算（）和动态计算。 静态文件，js，css，图片（大头）； 动态数据
数据变化频率 

### CDN
CDN部署在网络提供商的机房里面。在用户请求网站服务时，可以从距离自己最近的网络提供商获取数据。比如视频网站和内容网站的热点内容。

squid是缓存服务器科班出生
varnish是觉得squid性能不行，纯内存缓存服务器方案
nginx cache是属于不务正业，得益于nginx强大的性能
 
squid 越俎代庖自己实现了一套内存页/磁盘页的管理系统，但这个虚拟内存swap其实linux内核已经可以做得很好，squid的多此一举反而影响了性能

而varnish的内存管理完全交给内核，当缓存内容超过内存阈值时，内核会自动将一部分缓存存入swap中让出内存。以挪威一家报社的经验，1台varnish可以抵6台squid的性能。

nginx cache如知友所说更适合缓存纯文本体积较小的内容，不过如果对nginx框架理解够深，在其上搭建一个山寨varnish不是难事。

淘宝大量商品截图，基本都是缓存在

### RP
反向代理部署在网站的机房内，当用户请求到达中心机房后，首先访问的是反向代理服务器。如果反向代理中缓存者用户请求的资源，就将其直接返回给用户。

网站的静态资源如js，css，图片等资源独立分布式部署，并采用独立的域名。  

缓存整体请求数据；降低应用负载。浏览器并发能力限制。 

nginx   sendfile
### LB
dns 缓存，不能保证及时性。禁用缓存？ 自建cdn还是dns？

nginx+keepalived 。Nginx 提供负载均衡的能力，keepalived 提供健康检查，故障转移，提高系统的可用性。采用这样的架构以后很容易对现
有系统进行扩展，只要在后端添加或者减少realserver，只要更改配置文件，并能实现无缝配置变
更。在本项目中建议采用由Nginx 充当LoadBalancer 的职责，Keepalived 实现Nginx 的HA 的架
构模式，通过暴露虚拟IP（配置DNS 绑定域名）的形式对内容网站进行访问。

负载均衡解决集群问题 
lvs
硬件LB ，监控状态，负载均衡策略，路由转发 

反向代理
DNS 禁用缓存
数据链路层

算法  RR WRR  P105

DNS

### WEB APP


使用客户端缓存技术，yahoo 21 ，bigpipe 淘宝首页新技术？浏览器并发数限制，所以会把静态文件分发在不同域名上。
工具 yslow firebug httpwatch css_tidy 
                      
front web app   ：dns，
cdn （varnish，squid）， 小文件 cache系统。 小文件系统。 数据块的大小。 block ，node？？？
                         
restful api， mvc，velocity，jetty/tomcat，bigpipe，taobao 首页？？

 静态请求 不发送到实际生产系统 ；防止恶意数据进行缓存攻击？

 
session   framework  （web开发）

spring 管理对象生命周期。


### SOA
RPC框架，SDL Service Definition Language，服务定义语言，message type，service call，receiving type
功能集合，数据协议和传输协议
ali blog thift，pb， 
stub skelton
传统webservice  
cxf动态生成


netty                    
     
 mq  metaq，hsf，通过监控生产者，broker，消费者之间的队列情况，动态决定增加、减少消费者的


orm mybatis， sql meta data，反射。事务 threadlocal static finally remove
cache redis，江南白衣兄的redis 分享。 缓存集群？ 还是善用操作系统缓存。
solar 分布式搜索，中文分词库 

bi，机器学习分析用户行为，结合搜索进行推荐排名。 Hadoop，storm

运维 os （cpu，memory，disk（空间，读写次数）） 中间件 tomcat，jetty，jvm，network，

能源消耗 （制冷，电能，水冷） 地震带。 自动运维

存储    db,nosql,hbase, 分区表，字段压缩，查询优化，awr报告。

功能特点
核心原理
重要算法 

csdn介绍


### MQ
提升网站响应速度 
消除并发访问洪峰
 
异步回调功能
Kafka


### CACHE
存在热点数据，某个时间段内有效。
一致性Hash P109
LRU
缓存预热  
REDIS
### STORAGE
ssd vs 机械硬盘
ACID，Atomic，Consistent，Isolated，Durable

redo undo 定期刷新
存储 分为 大文件，小文件，结构化，非结构化，分布式文件存储和数据库存储。数据库存储 读写分离，垂直扩展（scale up） 分表，水平扩展（scale out）分库， 

分布式文件系统

数据一致性 级别

比RAID好多了”– 在一个非存储区域网络的RAID（non-SAN RAID）的建立中，磁盘是冗余的，但主机不是，如果你整个机器坏了，那么文件也将不能访问。 MogileFS分布式文件存储系统在不同的机器之间进行文件复制，因此文件始终是可用的。 主要是无法解决网络分区的问题。

分布式存储系统通常需要解决如下一些问题
* 数据分布  在多台服务器之间保证数据分布均匀，跨服务器如何读写
* 一致性  异常情况下如何保证副本一致性
* 容错  如何检测故障并进行故障迁移
* 负载均衡 新增、移除服务器时如何负载均衡 数据迁移如何不影响已有服务
* 事务并发控制  如何实现分布式事务，如何实现多版本并发控制
* 压缩、解压缩 根据数据特点选择恰当算法，如何平衡时间和空间的关系。

数据分类：

* 非结构化数据：文本，图片，视频音频
* 结构化数据：数据模式（属性，数据类型，数据之间的联系）与内容是分开定义。
* 半结构化数据：模式和内容混在一起，没有明显的区分。

分布式文件系统
适合存储blob对象。
一个大文件分成多个数据块（chunk），每个数据块大小相当。分布式文件系统将这些数据块分散到存储机器，并将用户对数据的操作转化为对若干个数据块的操作。

分布式键值系统
基于主键实现CRUD功能，通常使用一致性hash技术。

分布式表格系统
不仅仅支持基于主键的CURD操作，还支持扫描某个主键范围。一般仅支持单表操作。通常存储半结构化数据，不需要预先定义模式。

分布式数据库
二维表格组织数据，支持sql，多表关联，嵌套子查询等复杂操作，并支持并发数据库事务。

checkpoint 系统定期将内存的操作以某种易于加载的形式（checkpoint文件）转存到磁盘中，并记录checkpoint时刻的日志回放点，以后故障恢复只需要回放checkpoint时刻之后的redo日志。

行式存储 

列式存储
 
dynamo 亚马逊

### 配置管理
zk diamond

### SEARCH
搜索 分为 排序，推荐，BI,大数据
spark，storm 实时流处理

### 其他
安全分析 
安全，虚拟化 是贯穿全系统的 

开发，发布，监控，预警，运维

Agent —》 Explorer ，Analyze，Visual，Dashboard，Share，
 dapper  日志规范化 
 网易和weibo收藏
 failover
matrix  ，各种延迟，各种指标
collection
mornitor ， 图表，找到根因，重建索引，rebuild index
定期扫描应用日志，针对错误 进行告警 

开发环境，测试环境，灰色发布，回滚 流程，协调。 计划，特性开发。
SCR source code responsitoy   

package  编译 obj 独立部署
 
project 
          target
          dependency
                      version number
          build dependency


Deploy Environment 支持开速发布，不用大的cycle，灰色发布 ，通过LB来控制，先不发送请求 。根据系统使用率动态启动，停止实例。
         Host

云厂商 硬件申购， 
     因为：固定资产开销，可能闲置， 购买，管理，安装费用 ，无法迅速购买
     活动消费，类似开车和租车的区别 
     能源，制冷，运维成本，量大硬件定制
     充分利用闲置资源
数据中心
 
 
 
## 分布式系统原理
### 基本原理
网络RPC调用3种结果：成功  失败  超时。发生超时后，无法确认是否调用成功。
 
TCP 协议栈的 缓冲区中，应用程序不一定来得及正确处理。IO缓存也是，放在os缓存里面，定期刷新。

副本指在分布式系统中为数据或者服务提供的冗余。副本一致性是针对分布式系统而言的。

强一致性 单调一致性  会话一致性  最终一致性 弱一致性 
节选自
强一致性(strong consistency)：任何时刻任何用户或节点都可以读到最近一次成功更新的副本数
据。强一致性是程度最高的一致性要求，也是实践中最难以实现的一致性。 
单调一致性(monotonic consistency)：任何时刻，任何用户一旦读到某个数据在某次更新后的值，
这个用户不会再读到比这个值更旧的值。单调一致性是弱于强一致性却非常实用的一种一致性级别。
因为通常来说，用户只关心从己方视角观察到的一致性，而不会关注其他用户的一致性情况。 
会话一致性(session consistency)：任何用户在某一次会话内一旦读到某个数据在某次更新后的值，
这个用户在这次会话过程中不会再读到比这个值更旧的值。会话一致性通过引入会话的概念，在单
调一致性的基础上进一步放松约束，会话一致性只保证单个用户单次会话内数据的单调修改，对于
不同用户间的一致性和同一用户不同会话间的一致性没有保障。实践中有许多机制正好对应会话的
概念，例如 php 中的 session 概念。可以将数据版本号等信息保存在 session 中，读取数据时验证副
本的版本号，只读取版本号大于等于 session 中版本号的副本，从而实现会话一致性。 
最终一致性(eventual consistency)：最终一致性要求一旦更新成功，各个副本上的数据最终将达
到完全一致的状态，但达到完全一致状态所需要的时间不能保障。对于最终一致性系统而言，一个
用户只要始终读取某一个副本的数据，则可以实现类似单调一致性的效果，但一旦用户更换读取的
副本，则无法保障任何一致性。 
弱一致性(week  consistency)：一旦某个更新成功，用户无法在一个确定时间内读到这次更新的
值，且即使在某个副本上读到了新的值，也不能保证在其他副本上可以读到新的值。弱一致性系统
一般很难在实际中使用，使用弱一致性系统需要应用方做更多的工作从而使得系统可用。 

数据分布方式

hash 用户id的hash值 mod 服务器个数，缺点是扩展性差。一旦服务器个数变化，几乎所有数据需要被迁移并重新分布。可以增加中间层，即元数据服务器。需要防止数据倾斜问题。

还有两种，按数据范围分布和按数据量分布 。缺点都是元数据管理复杂。

一致性hash 通过引入虚节点的概念，虚节点的个数一般远大于未来集群中的机器数。首先根据数据的hash值找到虚节点，然后从元数据中找到真实节点。无论是增加节点还是节点宕机，都有助于实现全局负载均衡。

在存在多个副本的情况下，一般数据是以块的方式而不是机器的方式存放数据。这样便于在节点宕机后快速恢复数据以及负载均衡。

移动数据不如移动计算，本地化计算。

wal vs redo 

数据分裂和合并。

看完泛型篇，再看下ob的目录，浏览下其内部实现，看下是否有大概印象。



### 副本控制协议
#### 中心化副本控制协议
primary-secondary（也称primary-backup）。在该协议中，副本被分成两大类：primary副本，非primary副本，简称为secondary副本。维护primary副本的节点作为中心节点，中心节点负责维护数据的更新，并发控制和协调副本的一致性。

需要解决数据更新流程，数据读取流程，primary副本的确定和切换，数据同步。

* 外部节点把更新操作发给primary节点
* primary节点确定并发更新操作的先后顺序
* primary节点将更新操作发送给secondary节点
* primary节点根据secondary节点的完成情况决定更新操作是否成功，并将结果返回给外部节点。

如果由primary直接同时想其他N个副本的发送数据的话，那么每个secondar的更新吞吐受限于primary出口带宽的限制。所以，有些系统会使用副本接力的方式，比如primary发送个第一个secondary副本数据，第一个secondary副本发送第二个secondary数据，依次类推。

数据读取 由两种思路，随机确定primary副本，将数据分为数据段，以数据段为副本的基本单位，将副本分散到集群中。只要primary副本分散到集群中，即使只有primary副本提供读写服务，也可以充分利用集群机器资源。另一中思路就是主副本记录secondary是否可用。如果不可用，那么secondary副本可以继续尝试与primary副本同步数据，当完成数据同步时，primary副本将其标记位可用。

primary副本需要元数据服务器去维护。 存在如下问题，如何确定节点的状态以及发现原primary节点异常；切换primary后，不能影响副本一致性。 缺陷是，由于primary切换带来一定的停服时间。

数据同步存在3种情况：备副本完全落后主副本数据（新增副本节点），部分落后主副本数据（网络分化等原因），存在冗余副本数据（主副本没有更新，备副本反而进行了多余的修改操作）。3种解决方法 ：复制快照数据， 回放redo log，基于undo log 删除多余数据

副本复制分为两种，强同步复制和异步复制，两者的区别在于用户的请求是否在数据复制到其他副本上才返回成功。

一致性和可用性是矛盾的。强同步的问题的当备副本出现故障时，可能阻塞存储系统的正常写服务，可用性较差。异步复制协议的可用性较好，但是一致性得不到保障，主副本出现故障是还有数据丢失的可能。使用qurom 英 [ˈkwɔ:rəm]，法定人数。

复制概述：常见的做法是同步操作日志。主副本首先将操作日志同步到备副本，备副本回放操作日志，完成后通知主副本。接着，主副本修改本机，等到所有的操作都完成后再通知客户端写成功。

CAP:
一致性：读操作总是能够读取之前完成的写操作结果，满足这个条件我们称之为强一致性系统
可用性：读写操作单台机器发生故障的情况下仍然能够正常执行，不需要等待发生故障的机器重启或者该机器上面的服务前移到其他机器
分区可容忍性：机器故障，网络故障，机房停电等异常情况下仍然满足一致性和可用性。

CAP 理论指出：无法设计一种分布式协议，使得同时完全具备 CAP 三个属性，即 1)该种协议
下的副本始终是强一致性，2)服务始终是可用的，3)协议可以容忍任何网络分区异常；分布式系统
协议只能在 CAP 这三者间所有折中。 



预写式日志（Write-ahead logging，缩写 WAL）通常包括redo和undo信息。根据数据重要级别，决定是否每次都将数据落盘。


#### 去中心化副本控制协议 


lease，相当于租金，zk
的session 时间。

MVCC则使用copy-on-write来解决这个问题

服务框架自省（运维监控） 依赖关系统计，前台系统访问路径，自动、手工降级，系统问题自动排查甚至问题自动修复，时长，队列情况。


瘦客户端 还是胖客户端 瘦的避免频繁升级


备份和低一致性 来提升可用性和网络分区容忍性
hostclass —》 host
fault torlerent
每个消息存储3个节点 
at least once，重发+唯一主键策略。
故障检测，Faliure  Detection

数据压缩 批处理
亚马逊中文论文 ，中间件ali blog

集群  一群机器服务于同一个功能， 分布式 则是一群机器服务于不同的功能
 
ACID 一致性  两个事务，一增一减  i 4个隔离级别 RU RC RR SR

IOPS，即I/O per second，即每秒读写（I/O）操作的次数  http://zh.wikipedia.org/wiki/%E4%BA%8B%E5%8A%A1%E5%86%85%E5%AD%98

事务内存目前有两种实现方式，基于软件的STM（Software Transactional Memory）和基于硬件的HTM（Hardware Transactional Memory）。 
 
C 所有节点看到一致的数据 ，3个副本由2个写成功即可。 All or Nothing，or partcial???
A 
P 分布式算法，2pc 两阶段提交 mvcc

缓存穿透
         
一致性hash 用于缓存和数据分区。 但是后者join 比较困难。 维护成本？

两阶段提交：该协议通常用来实现分布式事务。系统一般包含两类节点：一类是协调者（coordinator），通常一个系统只有一个；另一类是事务参与者（participants），一般包含多个。协议中假设每个节点都会记录操作日志并持久化到非易失性存储介质。它分成两个阶段:
准备阶段：协调者通知事务参与者准备提交或者取消事务，然后进入表决过程。在表决过程中，参与者将告知协调者自己的的决策（同意还是取消）。
提交阶段：协调者根据第一个阶段的投票结果进行决策：提交还是取消。当且仅当所有参与者都统一提交事务，协调者才通知所有参与者提交事务，否则协调者通知所有参与者取消事务。参与者接收到协调者发送的消息后再执行相应的操作。

事务参与者发生故障 ：增加超时机制。
协调者发生故障：参考pdf分析文档。


paxos协议:画几张图

3阶段提交 酷壳文章

google的几大论文+ 

### 优秀设计思想
 dubbo作者
faliure detection 
 通过增加一层来解决问题。包括日志的mvc模型，日常的模块解耦，map-reduce模型，
各种事件，启动，停止，

数据中心，自动化代码管理，测试，安全检查
  
移位操作 OP_ACCEPT,OP_READ。。。
 
 通过负载均衡来开启新机器的路由 
数据预处理。
thread local 隐式传参，线程安全

HLR 位置营销 救援 
 ring buffer
  
度量工具，静态检查，安全扫描工具
 coc 约定优于配置 

springside的推荐
  
string hashcode —》 cache
hashmap —》 2的n次方
valueOf
 
core+plugin(ConfigFile/参数设置+ Interpter Filter Pattern+ Observer Pattern)+eat dogfood

paxos 扩展协议

心跳检查
 
 
何谓架构，很多是一家之言。
 
根据业务划分多个子系统 
  
用户用量计费  读写，网络消耗，  发送  中心，计算账单 数据服务  
     
连接恢复，还是新开连接？
   
8-10个人，负责一两个service
领导的需求             

根据业务区分不同的业务部门  业务架构 
     
TDDL ， sql proxy、agent，binlog sync 分区分表 
  
白马非马，架构是什么？内涵 外延 。归纳和演绎。 不完全归纳。 混淆内涵和外延。
 
log4j 只有一个log组件，通过 find xar jar ?? 见csdn 收藏。
## 互联网常用算法
所谓记忆，就是大脑的电信号之间的连接。脑介质就是存储介质。 一个输入究竟能够引起多少电反应，通常用来描述的人的智商。

我想补课，从高等数学，离散数学，概率统计等科目开始。做完重要的练习题。等系统地学完了再学习算法与数据结构。每个算法都必须要使用java和c语言来描述一遍，要有单元测试用例。该有图的时候贴图。然后在leetcode上刷题。

wisper 文章
数据结构还是要三言两语下。看时间考虑下july的文章。

将doc转成md，支持图片。

二分
快排
B+树
前缀索引
布隆算法
剪枝算法
radix tree 
倒排索引
trie common prefix search+全文搜索的scoring（打分）机制
纠错算法，垃圾邮件算法 日本那几个折叠 架构的折叠
压缩 lz系列算法，找数据的重复或者规律，用尽量少的字节表示。
lru/lirs(两级缓存池)
lsm
cow copy on write
连接泄露原理是查询session视图，获得每个session的创建时间，看看那些session生命周期过长。然后找到对应执行的sql语句和业务代码。
 
写出脉络，框架，再去搞细节。
 
把发生故障当成常态来设计
配置统一管理
 
dsl

对象状态

open api
 
robbin 的cache 设计
 
bean tostring
框架设计原则和范式


通用系统
特色系统


尽量避免依赖第三方jar
生态系统建设
* 内部
* 外部
 
支持扩展点，插件 

csdn的双11介绍
  
## 参考


* 《大规模分布式存储系统原理解析与架构实战》
* 《大型网站技术架构核心原理与案例分析》
* 《分布式系统原理介绍》
* 《大规模Web服务开发技术》
* 《程序员》 2014 第一期
*  [varnish / squid / nginx cache 有什么不同？](http://www.zhihu.com/question/20143441)

## 计算机系统原理入门

对汇编指令的学习，属于生态系统和职责分工。 编译原理，cpu，操作系统， 但是由于遗忘特性

输入，计算，输出

AUPE

内核 vs 库函数   sbrk vs malloc
creat 是 open 的简便函数，封装了open
lseek 没有发生实际的io操作
进程终止时，内核会自动释放句柄
read ahead 、write behind  P71
sync 加入写队列缓存就返回，fsync 写入到磁盘后才返回
为了打开文件，需要具有文件所在目录的执行权限
void *

I/O多路复用（I/O multiplexing）首先构造一张有关描述符的列表，然后调用一个函数，直到这些描述符中的一个已经准备I/O时，该函数才返回。在返回时，它告诉进程哪些描述符已经准备好可以进行I/O

poll、pselect和select这3个函数使我们能够执行I/O多路复用。

p581 

单机 
多机
网络拓扑
协议定义
协议实现
google CLOS

---

网络编程

电话类比网络连接关系原来在UP中已经阐述。

TIME_WAIT 允许最大跳数内的并且小于2MSL的数据包重传

P36 3次握手状态

P78

p85  baklog 图

listen 指定 backlog。内核维护两个队列 未完成连接队列（处于SYN_RCVD状态），已完成连接队列

毒药 和哨兵 dummy

syn flood 攻击  忽略了大量关于c语言之间的描述

accept 监听套接字 和  已连接套接字  前者一直存在  后者用完则关闭

p92

p122 必读 nio

select 的最大描述符设置需要重新编译或者使用新版本的的参数设置；线性搜索，扩展能力差。
选择 epoll

select 可读，可写，异常
无限等待，等待某段时间，不等待

p361 解释了 为什么需要finishConnect

僵尸进程，处理signal 。sigal handler

NUMA 可以快速访问本地内存，访问远程内存速度较慢。 

ssd 多路复用

一步步解释为什么操作系统会这么复杂
基本的输入，输出模型
性价比 
为了提升性能而做的各种tradeoff
引入一种模型后，然后又存在哪些问题
虚拟内存，tlb，cpu，磁盘

多路复用


一步步解释为什么操作系统会这么复杂
基本的输入，输出模型
性价比 
为了提升性能而做的各种tradeoff
引入一种模型后，然后又存在哪些问题
虚拟内存，tlb，cpu，磁盘


dubbo 怎么使用Javaassist的


AtomicIntegerFieldUpdater

infoq 2个人 文章复习 我的blog文章复习
网易那篇多线程复习 

通用设计，领域设计

整体浏览我的日志 

CSAPP 

补码是非对称编码
补码计算 

P43 介绍 反码和原码
 
抓住主要矛盾

性价比原理 寄存器 缓存  内存 磁盘
局部性原理（时间局部性 和空间局部性）：在具备良好时间局部性的程序中，被引用一次的存储器位置很可能在不远的将来会被再次引用。在具备良好空间局部性的程序中，被引用一次的存储器位置的附近位置很可能在不远的将来会被再次引用。

 cach miss （矩阵计算，二维数组本质上是一维数组，双重循环），false sharing
并发性原理 取指(内存到寄存器) 译码（） 计算  访存  写回  更新pc  流水线  乱序执行  分支预测(排序执行)
虚拟内存原理 ：更多进程需要更多内存，高效管理内存。 
tlb  方便管理内存，避免重复IO 虚拟内存 支持
	 内存容量不够 swap机制
扫一扫+工具检测 
降低循环内的低效计算
数组和链表的区别
并发锁的粒度和策略

cpu --存储控制器  -- 内存 -- 先将行数据复制到内存的内部缓冲区内，然后再根据列去取数据

地址，数据 内存 

锁的本质内部实现？总线锁定？行锁


旋转磁盘和固态硬盘

磁盘 ：512字节 300扇区 20000磁道  2盘面 5盘片 

寻道时间 旋转时间 传送时间 前2者耗时较大，访问第一个自己耗费很长时间，后面几乎不耗费时间。所以操作系统会预读。。

逻辑磁盘块：现代磁盘构造复杂，为了对os隐藏这些复杂性，现代磁盘提供了一个简单的视图，称为逻辑块。磁盘控制器维护着逻辑块和实际物理的磁盘扇区之间的映射关系。os执行i/o操作时，通过制定逻辑块号，磁盘控制器的固件执行一个快速查找，将逻辑号翻译成（盘面，磁道，删除）的3元组，这个3元组唯一标识了对应的物理扇区。控制器的硬件解释这个3元组，将读、写头移动到适当的柱面，等待扇区移动到读写头下，将读写头感知的位放到控制器里面的一个小缓冲区内，然后复制到内存中。


虽然xxx详细描述超出了我们的讨论反问，但是我们可以概要描述下。


存储器映射I/O: cpu使用这种技术来想i/o设备发送命令。首先在唉地址空间中。有一块地址是为与I/O设备通信保留的。每个这样的地址称为一个I/O port。当一个I/O设备连接到总线时，它与一个或多个端口相关联。

cpu可能通过执行3个对 I/O port （比如为0Xa0）的存储指令。当磁盘控制器收到cpu读命令后，它将逻辑块翻译成扇区地址 ，然后将内容直接传送到主存，不需要cpu的干涉。这种过程称为DMA。

TLB MMU

6。4章节 P409那个t翻译错误，应该是标记位。

图，文不在一页真的很烦。

direct mapped cache  将内存地址分为3部分  标记位  组索引 和 偏移量，偏移量表示从什么地方开始取数据。

内存分页 和 cache 分页相对应。

虚拟存储器是一个数组，一个存放在磁盘上的N个连续的字节大小的单元组成的数组。
分为 未分配 ，未缓存，已缓存，
   未分配  不占用内存和磁盘空间
   未缓存  不占用内存，占用磁盘
   已缓存  占用内存和磁盘
虚拟存储器分为多个页面，每个页面称为虚拟页，是一个大小固定的块。

页表（在内存中） 数据结构，存放了虚拟页到物理页的映射关系（读写目标）
操作系统 负责维护页表的内容，以及在磁盘和内存中传送页。（写）
MMU（硬件），地址翻译硬件，负责在将虚拟内存转换成物理内存时读取页表。（读）    
     高速缓存、内存
发生缺页中断后，会把被牺牲的脏页写回以及交换页面。

TLB是MMU硬件内部的一个小缓存，用来加速翻译。



根据http://www.hardtoc.com/archives/119 引用的标准， -2147483648 是一个常量表达式，首先是获取2147483648 ，然后计算-这个符号。但是在获取时2147483648，已经发生溢出。会变成一个 unsigned long int 或者long long int. 

http://www.cnblogs.com/baiweiguo/archive/2013/01/15/2861286.html
http://blog.sweelia.com/articles/2013/01/05/1357370792163.html

深入分析javaweb技术内部的 tomcat（how tomcat works），spring，ibatis

### LINUX重要命令
yufeng blog 那张图 命令及原理

### 重要细节
同一个数据中心延时较小，网络一次来回的时间在1毫秒之内。北京，杭州距离1300km，光在信息传输时走折线，假设折现距离是直线距离的1.5倍，那么整个耗时 1300*1.5*2/300000=13毫秒，实测时40毫秒。 

分布式存储系统 p10 性能参数 

http://jm-blog.aliapp.com/?p=1379 扣钱加锁，异步
http://jm-blog.aliapp.com/?p=1387 
skiplist

{% include JB/setup %}
